// client/src/clashmenu/battle/BattlePanel.js - VERSION DIAGNOSTIC SIMPLE
export default class BattlePanel {
    constructor(scene, config = {}) {
        this.scene = scene;
        this.config = config;
        this.container = null;
        this.isVisible = false;
        
        // Dimensions
        this.width = scene.scale.width;
        this.height = scene.scale.height;
        this.isMobile = scene.isMobile || false;
        
        console.log('üèóÔ∏è BattlePanel constructor d√©marr√©');
        console.log('üîç Scene valide:', !!scene);
        console.log('üîç Scene.add valide:', !!(scene && scene.add));
        
        // Initialiser imm√©diatement
        this.init();
    }
    
    init() {
        console.log('üèóÔ∏è BattlePanel.init() d√©marr√©');
        
        try {
            // Cr√©er container avec v√©rifications
            console.log('üîç Cr√©ation container...');
            this.container = this.scene.add.container(0, 0);
            console.log('‚úÖ Container cr√©√©:', !!this.container);
            console.log('üîç Container type:', this.container.constructor.name);
            
            // Cr√©er contenu minimal
            this.createSimpleContent();
            
            console.log('‚úÖ BattlePanel initialis√© avec succ√®s');
            
        } catch (error) {
            console.error('‚ùå Erreur init BattlePanel:', error);
            this.container = null;
        }
    }
    
    createSimpleContent() {
        console.log('üé® Cr√©ation contenu simple...');
        
        try {
            // Titre simple
            const title = this.scene.add.text(
                this.width / 2, 100,
                '‚öîÔ∏è BATAILLE PANEL',
                {
                    fontSize: '24px',
                    fontWeight: 'bold',
                    fill: '#FFD700',
                    align: 'center'
                }
            );
            title.setOrigin(0.5);
            
            console.log('‚úÖ Titre cr√©√©:', !!title);
            
            // Ajouter au container
            this.container.add(title);
            console.log('‚úÖ Titre ajout√© au container');
            
            // Bouton Matchmaking simple
            const matchmakingBg = this.scene.add.graphics();
            matchmakingBg.fillStyle(0xFF6347);
            matchmakingBg.fillRoundedRect(
                this.width / 2 - 110, 150,
                220, 60, 12
            );
            
            const matchmakingText = this.scene.add.text(
                this.width / 2, 180,
                'üéØ MATCHMAKING',
                {
                    fontSize: '18px',
                    fontWeight: 'bold',
                    fill: '#FFFFFF'
                }
            );
            matchmakingText.setOrigin(0.5);
            
            // Zone interactive
            const hitArea = this.scene.add.zone(
                this.width / 2, 180,
                220, 60
            ).setInteractive();
            
            hitArea.on('pointerdown', () => {
                console.log('üéØ Bouton Matchmaking cliqu√© !');
                this.handleMatchmaking();
            });
            
            // Ajouter au container
            this.container.add([matchmakingBg, matchmakingText, hitArea]);
            console.log('‚úÖ Bouton Matchmaking cr√©√©');
            
            // Texte d'√©tat
            const statusText = this.scene.add.text(
                this.width / 2, 250,
                'Panel Battle charg√© avec succ√®s !\nBouton Matchmaking fonctionnel.',
                {
                    fontSize: '14px',
                    fill: '#B0C4DE',
                    align: 'center'
                }
            );
            statusText.setOrigin(0.5);
            
            this.container.add(statusText);
            console.log('‚úÖ Contenu simple cr√©√©');
            
        } catch (error) {
            console.error('‚ùå Erreur cr√©ation contenu:', error);
        }
    }
    
    handleMatchmaking() {
        console.log('üéØ Matchmaking lanc√© !');
        
        // Action simple pour test
        if (this.config.onAction) {
            this.config.onAction('matchmaking', {
                type: 'test_matchmaking',
                timestamp: Date.now()
            });
        }
        
        // Afficher notification
        this.showSimpleNotification('üéØ Matchmaking lanc√© !');
    }
    
    showSimpleNotification(message) {
        try {
            const notification = this.scene.add.text(
                this.width / 2, 320,
                message,
                {
                    fontSize: '16px',
                    fontWeight: 'bold',
                    fill: '#32CD32',
                    backgroundColor: '#000000',
                    padding: { x: 20, y: 10 }
                }
            );
            notification.setOrigin(0.5);
            notification.setDepth(1000);
            
            // Animation
            notification.setAlpha(0);
            this.scene.tweens.add({
                targets: notification,
                alpha: 1,
                duration: 300
            });
            
            // Auto-suppression
            this.scene.time.delayedCall(3000, () => {
                this.scene.tweens.add({
                    targets: notification,
                    alpha: 0,
                    duration: 200,
                    onComplete: () => notification.destroy()
                });
            });
            
        } catch (error) {
            console.error('‚ùå Erreur notification:', error);
        }
    }
    
    // === M√âTHODES REQUISES POUR PANELMANAGER ===
    
    getContainer() {
        console.log('üîç getContainer() appel√©, container:', !!this.container);
        return this.container;
    }
    
    show(animate = true) {
        console.log('üëÅÔ∏è show() appel√©');
        
        if (!this.container) {
            console.error('‚ùå Pas de container pour show()');
            return;
        }
        
        try {
            this.container.setVisible(true);
            this.isVisible = true;
            
            if (animate) {
                this.container.setAlpha(0);
                this.scene.tweens.add({
                    targets: this.container,
                    alpha: 1,
                    duration: 300
                });
            }
            
            console.log('‚úÖ Panel affich√©');
        } catch (error) {
            console.error('‚ùå Erreur show():', error);
        }
    }
    
    hide(animate = true) {
        console.log('üôà hide() appel√©');
        
        if (!this.container) {
            console.error('‚ùå Pas de container pour hide()');
            return;
        }
        
        try {
            this.isVisible = false;
            
            if (animate) {
                this.scene.tweens.add({
                    targets: this.container,
                    alpha: 0,
                    duration: 200,
                    onComplete: () => {
                        this.container.setVisible(false);
                    }
                });
            } else {
                this.container.setVisible(false);
            }
            
            console.log('‚úÖ Panel masqu√©');
        } catch (error) {
            console.error('‚ùå Erreur hide():', error);
        }
    }
    
    isShown() {
        return this.isVisible;
    }
    
    updateData(newData) {
        console.log('üìä updateData() appel√©:', newData);
        // Pas d'action pour la version simple
    }
    
    destroy() {
        console.log('üóëÔ∏è destroy() appel√©');
        
        try {
            if (this.container) {
                this.container.destroy();
                this.container = null;
            }
            console.log('‚úÖ Panel d√©truit');
        } catch (error) {
            console.error('‚ùå Erreur destroy():', error);
        }
    }
    
    // === M√âTHODES DE DEBUG ===
    
    getDiagnostic() {
        return {
            containerExists: !!this.container,
            containerVisible: this.container ? this.container.visible : false,
            isVisible: this.isVisible,
            sceneValid: !!(this.scene && this.scene.add),
            configValid: !!this.config
        };
    }
}

// === FONCTIONS DE TEST GLOBALES ===
if (typeof window !== 'undefined') {
    
    // Test du BattlePanel simple
    window.testSimpleBattlePanel = () => {
        console.log('üß™ Test BattlePanel simple...');
        
        const gameInstance = window.ChimArenaInstance;
        const scenes = gameInstance?.game?.scene?.getScenes();
        const clashScene = scenes?.find(s => s.scene.key === 'ClashMenuScene');
        
        if (clashScene?.panelManager) {
            return clashScene.panelManager.forceLoadRealPanel('battle');
        } else {
            console.error('‚ùå PanelManager non trouv√©');
            return false;
        }
    };
    
    // Diagnostic du panel battle actuel
    window.debugBattlePanel = () => {
        const gameInstance = window.ChimArenaInstance;
        const scenes = gameInstance?.game?.scene?.getScenes();
        const clashScene = scenes?.find(s => s.scene.key === 'ClashMenuScene');
        
        if (clashScene?.panelManager) {
            const battlePanel = clashScene.panelManager.panels.get('battle');
            
            if (battlePanel && battlePanel.getDiagnostic) {
                const diagnostic = battlePanel.getDiagnostic();
                console.group('üîç DIAGNOSTIC BATTLE PANEL');
                console.table(diagnostic);
                console.groupEnd();
                return diagnostic;
            } else {
                console.log('‚ùå Pas de panel battle ou pas de m√©thode getDiagnostic');
                return null;
            }
        } else {
            console.error('‚ùå PanelManager non trouv√©');
            return null;
        }
    };
    
    console.log(`
üß™ === TESTS BATTLE PANEL SIMPLE ===

üîç DIAGNOSTIC:
‚ñ∂Ô∏è debugBattlePanel() - √âtat du panel battle

üß™ TESTS:
‚ñ∂Ô∏è testSimpleBattlePanel() - Charger version simple
‚ñ∂Ô∏è forceLoadRealPanel('battle') - Charger version compl√®te

COMMENCEZ PAR: testSimpleBattlePanel()
    `);
}
